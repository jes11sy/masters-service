generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Master {
  id          Int      @id @default(autoincrement())
  cities      String[]
  name        String
  login       String?  @unique
  password    String?
  passportDoc String?  @map("passport_doc")
  contractDoc String?  @map("contract_doc")
  statusWork  String   @map("status_work")
  dateCreate  DateTime @default(now()) @map("date_create")
  note        String?
  tgId        String?  @map("tg_id")
  chatId      String?  @map("chat_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  orders    Order[]
  schedules MasterSchedule[]

  // ✅ FIX #167: Оптимизированные индексы (удалены дубликаты)
  // REMOVED: @@index([login]) — @unique уже создаёт индекс автоматически
  @@index([statusWork, dateCreate]) // Для фильтрации и сортировки (покрывает statusWork-only)
  // REMOVED: @@index([statusWork]) — дубликат, покрыт [statusWork, dateCreate]
  // ✅ FIX #164: GIN индекс для поиска по массиву городов (PostgreSQL)
  @@index([cities], type: Gin)
  @@map("master")
}

model MasterSchedule {
  id        Int      @id @default(autoincrement())
  masterId  Int      @map("master_id")
  date      DateTime @db.Date
  isWorkDay Boolean  @default(true) @map("is_work_day")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  master Master @relation(fields: [masterId], references: [id], onDelete: Cascade)

  @@unique([masterId, date])
  @@index([masterId, date])
  @@index([date])
  @@map("master_schedule")
}

model Order {
  id                   Int       @id @default(autoincrement())
  rk                   String
  city                 String
  avitoName            String?   @map("avito_name")
  phone                String
  typeOrder            String    @map("type_order")
  clientName           String    @map("client_name")
  address              String
  dateMeeting          DateTime  @map("date_meeting")
  typeEquipment        String    @map("type_equipment")
  problem              String
  callRecord           String?   @map("call_record")
  statusOrder          String    @map("status_order")
  masterId             Int?      @map("master_id")
  result               Decimal?  @db.Decimal(10, 2)
  expenditure          Decimal?  @db.Decimal(10, 2)
  clean                Decimal?  @db.Decimal(10, 2)
  masterChange         Decimal?  @map("master_change") @db.Decimal(10, 2)
  bsoDoc               String[]  @default([]) @map("bso_doc")
  expenditureDoc       String[]  @default([]) @map("expenditure_doc")
  operatorNameId       Int       @map("operator_name_id")
  createDate           DateTime  @map("create_date")
  closingData          DateTime? @map("closing_data")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  avitoChatId          String?   @map("avito_chatid")
  callId               String?   @map("call_id")
  prepayment           Decimal?  @db.Decimal(10, 2)
  dateClosmod          DateTime? @map("date_closmod")
  comment              String?
  cashSubmissionStatus String?   @default("Готово") @map("cash_submission_status")
  cashSubmissionDate   DateTime? @map("cash_submission_date")
  cashSubmissionAmount Decimal?  @map("cash_submission_amount") @db.Decimal(10, 2)
  cashReceiptDoc       String?   @map("cash_receipt_doc")
  cashApprovedBy       Int?      @map("cash_approved_by")
  cashApprovedDate     DateTime? @map("cash_approved_date")
  // ✅ FIX #146: SetNull - заказ остаётся, мастер открепляется
  master               Master?   @relation(fields: [masterId], references: [id], onDelete: SetNull)
  
  // Существующие индексы
  @@index([statusOrder, city])
  @@index([closingData])
  @@index([masterId, city, closingData])
  @@index([phone])
  @@index([createDate, city])
  @@index([operatorNameId])
  @@index([createDate])
  @@index([avitoName])
  
  // ✅ FIX #167: Оптимизированные индексы (удалены дубликаты)
  @@index([masterId, statusOrder]) // Покрывает masterId-only запросы (leftmost prefix)
  @@index([masterId, createDate]) // Для статистики по датам
  @@index([statusOrder, cashSubmissionStatus]) // Для getHandoverSummary
  // REMOVED: @@index([cashSubmissionStatus, statusOrder]) — альтернативный порядок редко нужен
  // REMOVED: @@index([masterId]) — дубликат, покрыт [masterId, statusOrder]
  
  @@map("orders")
}

